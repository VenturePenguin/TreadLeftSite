<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f8fafc;
            color: #334155;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        p { margin-top: 10px; font-size: 16px; }
        .error { color: #ef4444; }
        #debug { margin-top: 20px; font-size: 12px; color: #94a3b8; word-break: break-all; max-width: 90%; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <h3>Connecting to TreadLeft...</h3>
    <p>Please wait while we redirect you back to the app.</p>
    <div id="debug"></div>

    <script>
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                scope: params.get('scope')
            };
        }

        // Helper to decode Base64Url
        function base64UrlDecode(str) {
            try {
                // Add padding if needed
                let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) {
                    base64 += '=';
                }
                return decodeURIComponent(escape(window.atob(base64)));
            } catch (e) {
                console.error('Base64 decode error:', e);
                return null;
            }
        }

        function redirect() {
            const { code, state, error } = getQueryParams();
            const debugEl = document.getElementById('debug');

            if (error) {
                document.body.innerHTML = `<h3 class="error">Access Denied</h3><p>You denied access to Strava. Please try again.</p>`;
                return;
            }

            if (!code || !state) {
                document.body.innerHTML = `<h3 class="error">Invalid Request</h3><p>Missing code or state parameter.</p>`;
                return;
            }

            try {
                // 'state' parameter contains the 'returnTo' URL (encoded)
                // e.g. treadleftapp://oauth-return
                const returnTo = base64UrlDecode(state);

                if (!returnTo) {
                    throw new Error('Could not decode state parameter');
                }

                debugEl.innerText = `Redirecting to: ${returnTo}`;

                // Construct final redirect URL
                // We append the code so the app can use it
                // We keep other params like scope just in case, though usually code is enough
                const separator = returnTo.includes('?') ? '&' : '?';
                const finalUrl = `${returnTo}${separator}code=${code}`;

                // Redirect back to the app
                window.location.href = finalUrl;
                
                // Fallback for some browsers/situations: try to open after a delay
                setTimeout(() => {
                    document.body.innerHTML += `<p>If you aren't redirected automatically, <a href="${finalUrl}">click here</a>.</p>`;
                }, 2000);

            } catch (err) {
                console.error(err);
                document.body.innerHTML = `<h3 class="error">Error</h3><p>${err.message}</p>`;
            }
        }

        window.onload = redirect;
    </script>
</body>
</html>
