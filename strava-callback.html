<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Strava Callback</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; padding: 24px; }
      .card { max-width: 560px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; }
      .btn { display: inline-block; background: #f97316; color: white; padding: 12px 16px; border-radius: 12px; text-decoration: none; font-weight: 700; }
      .muted { color: #6b7280; font-size: 14px; }
      code { word-break: break-all; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1 style="margin:0 0 8px 0; font-size:18px;">Returning to TreadLeft…</h1>
      <p class="muted" style="margin:0 0 16px 0;">If you are not sent back to the app automatically, tap the button below.</p>
      <p id="status" class="muted" style="margin:0 0 16px 0;"></p>
      <p style="margin:0 0 16px 0;">
        <a id="returnLink" class="btn" href="#">Return to App</a>
      </p>
      <details class="muted">
        <summary>Debug details</summary>
        <div style="margin-top:12px;">
          <div><strong>code</strong>: <code id="dbgCode"></code></div>
          <div style="margin-top:6px;"><strong>error</strong>: <code id="dbgError"></code></div>
          <div style="margin-top:6px;"><strong>state</strong>: <code id="dbgState"></code></div>
          <div style="margin-top:6px;"><strong>returnTo</strong>: <code id="dbgReturn"></code></div>
          <div style="margin-top:6px;"><strong>target</strong>: <code id="dbgTarget"></code></div>
        </div>
      </details>
    </div>
    <script>
      (function () {
        var params = new URLSearchParams(window.location.search);
        var code = params.get('code');
        var error = params.get('error');
        var state = params.get('state');

        function safeDecodeState(v) {
          if (!v) return null;
          try {
            // state may be URI encoded and/or base64url encoded
            var s = decodeURIComponent(v);
            // base64url -> base64
            s = s.replace(/-/g, '+').replace(/_/g, '/');
            while (s.length % 4) s += '=';
            return atob(s);
          } catch (e) {
            try {
              return decodeURIComponent(v);
            } catch (e2) {
              return null;
            }
          }
        }

        var returnTo = safeDecodeState(state);

        // Fallback: show something useful if state is missing
        if (!returnTo) {
          document.getElementById('status').innerText = 'Missing return URL. Please go back to the app and try again.';
          document.getElementById('dbgCode').innerText = code || '';
          document.getElementById('dbgError').innerText = error || '';
          document.getElementById('dbgState').innerText = state || '';
          return;
        }

        var sep = returnTo.indexOf('?') === -1 ? '?' : '&';
        var target = returnTo;
        if (code) target += sep + 'code=' + encodeURIComponent(code);
        else if (error) target += sep + 'error=' + encodeURIComponent(error);
        else target += sep + 'error=' + encodeURIComponent('missing_code');

        document.getElementById('dbgCode').innerText = code || '';
        document.getElementById('dbgError').innerText = error || '';
        document.getElementById('dbgState').innerText = state || '';
        document.getElementById('dbgReturn').innerText = returnTo || '';
        document.getElementById('dbgTarget').innerText = target || '';

        var link = document.getElementById('returnLink');
        link.setAttribute('href', target);
        link.addEventListener('click', function () {
          document.getElementById('status').innerText = 'Opening the app…';
        });

        // Try auto redirect first; some browsers block exp:// unless user-initiated.
        document.getElementById('status').innerText = 'Attempting to open the app…';
        setTimeout(function () {
          try { window.location.href = target; } catch (e) {}
        }, 50);
      })();
    </script>
  </body>
</html>
